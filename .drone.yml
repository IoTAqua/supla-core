kind: pipeline
name: default

steps:
- name: supla-server-test
  image: mariadb
  commands:
    - apt-get update -y
    - apt-get -y install valgrind libmariadbclient-dev-compat make build-essential
    - test/supla-server-test.sh
  environment:
    DBHOST: db

- name: supla-scheduler-test
  image: mariadb
  commands:
    - apt-get update -y
    - apt-get -y install valgrind libmariadbclient-dev-compat make build-essential
    - ./test/supla-scheduler-test.sh
  environment:
    DBHOST: db

- name: supla-dev-test
  image: mariadb
  commands:
    - apt-get update -y
    - apt-get -y install valgrind libmariadbclient-dev-compat make build-essential
    - ./test/supla-dev-test.sh
  environment:
    DBHOST: db

- name: supla-consol-test
  image: mariadb
  commands:
    - apt-get update -y
    - apt-get -y install valgrind libmariadbclient-dev-compat make build-essential
    - ./test/supla-consol-test.sh
  environment:
    DBHOST: db

- name: joining
  image: mariadb
  depends_on: [supla-server-test, supla-scheduler-test, supla-dev-test, supla-console-client-test]
  commands:
    - echo "test"
      
    #- name: test
    # image: mariadb
  #  commands:
  # - ./supladevicetests --gtest_repeat=50 --gtest_shuffle

#- name: slack
#  image: plugins/slack
#  settings:
#    webhook: 
#      from_secret: slack_webhook 
#    channel: github
#    username: drone
#
#    # here's the template :)
#    # notice that the repo endpoint is hardcoded to `https://github.com/`. 
#    # you may adjust it accordingly.
#    template: >
#      {{#if build.pull }}
#        *{{#success build.status}}✔{{ else }}✘{{/success}} {{ uppercasefirst build.status }}*: <https://github.com/{{ repo.owner }}/{{ repo.name }}/pull/{{ build.pull }}|Pull Request #{{ build.pull }}>
#      {{else}}
#        *{{#success build.status}}✔{{ else }}✘{{/success}} {{ uppercasefirst build.status }}: Build #{{ build.number }}* (type: `{{ build.event }}`)
#      {{/if}}
#
#      Commit: <https://github.com/{{ repo.owner }}/{{ repo.name }}/commit/{{ build.commit }}|{{ truncate build.commit 8 }}> at: <https://github.com/{{ repo.owner }}/{{ repo.name }}/commits/{{ build.branch }}|{{repo.owner}}/{{repo.name}}/{{ build.branch }}> by: {{ build.author }}
#
#      <{{ build.link }}|Visit build page ↗>
#  when:
#    status: [success, failure]

services:
- name: db
  image: mariadb
  environment:
    MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    MYSQL_DATABASE: test
